<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>WEX FSA Consumer Portal</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background-color: #f5f5f5;
            color: #333;
        }

        .app {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }

        header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 30px;
            border-radius: 10px;
            margin-bottom: 30px;
            text-align: center;
        }

        header h1 {
            font-size: 2.5rem;
            margin-bottom: 10px;
        }

        .connect-provider-cta {
            background: white;
            padding: 40px;
            border-radius: 10px;
            text-align: center;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }

        .connect-provider-cta h2 {
            font-size: 2rem;
            margin-bottom: 15px;
            color: #2d3748;
        }

        .connect-provider-cta p {
            font-size: 1.1rem;
            color: #718096;
            margin-bottom: 30px;
        }

        .connect-button {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            padding: 15px 30px;
            font-size: 1.1rem;
            border-radius: 8px;
            cursor: pointer;
            transition: transform 0.2s;
        }

        .connect-button:hover {
            transform: translateY(-2px);
        }

        .connect-button:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
        }

        .overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1000;
        }

        .overlay-content {
            background: white;
            padding: 40px;
            border-radius: 10px;
            text-align: center;
            max-width: 400px;
        }

        .overlay-content h3 {
            font-size: 1.5rem;
            margin-bottom: 15px;
            color: #2d3748;
        }

        .overlay-content p {
            color: #718096;
            margin-bottom: 20px;
        }

        .loading-spinner {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #667eea;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 0 auto 20px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .transaction-section {
            background: white;
            padding: 30px;
            border-radius: 10px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }

        .transaction-section h2 {
            font-size: 1.8rem;
            margin-bottom: 20px;
            color: #2d3748;
        }

        .transaction-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
        }

        .transaction-table th,
        .transaction-table td {
            padding: 12px;
            text-align: left;
            border-bottom: 1px solid #e2e8f0;
        }

        .transaction-table th {
            background-color: #f7fafc;
            font-weight: 600;
            color: #4a5568;
        }

        .transaction-table tr:hover {
            background-color: #f7fafc;
        }

        .status-pending {
            color: #d69e2e;
            font-weight: 600;
        }

        .status-approved {
            color: #38a169;
            font-weight: 600;
        }

        .status-error {
            color: #e53e3e;
            font-weight: 600;
        }

        .hidden {
            display: none;
        }

        .success-message {
            background: #c6f6d5;
            color: #22543d;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
            border-left: 4px solid #38a169;
        }

        .error-message {
            background: #fed7d7;
            color: #742a2a;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
            border-left: 4px solid #e53e3e;
        }
    </style>
</head>
<body>
    <div class="app">
        <header>
            <h1>WEX FSA Consumer Portal</h1>
            <p>Provider-Verified Substantiation</p>
        </header>

        <main>
            <!-- Connect Provider CTA -->
            <div id="connectProviderCTA" class="connect-provider-cta">
                <h2>Connect Your Provider</h2>
                <p>Automatically verify your healthcare expenses with zero-touch approval</p>
                <button id="connectButton" class="connect-button" onclick="handleConnectProvider()">
                    Connect My Provider
                </button>
            </div>

            <!-- Authentication Overlay -->
            <div id="authOverlay" class="overlay hidden">
                <div class="overlay-content">
                    <div class="loading-spinner"></div>
                    <h3>Connecting to Provider...</h3>
                    <p>Please wait while we authenticate with your healthcare provider.</p>
                </div>
            </div>

            <!-- Transaction Section -->
            <div id="transactionSection" class="transaction-section hidden">
                <h2>My Provider Claims</h2>
                <div id="successMessage" class="success-message hidden">
                    ✅ Successfully connected to Trellis Healthcare
                </div>
                <div id="errorMessage" class="error-message hidden">
                    ❌ Connection failed. Please try again.
                </div>
                <table id="transactionTable" class="transaction-table">
                    <thead>
                        <tr>
                            <th>Provider</th>
                            <th>Date</th>
                            <th>Amount</th>
                            <th>Status</th>
                            <th>Source</th>
                        </tr>
                    </thead>
                    <tbody id="transactionTableBody">
                        <!-- Transactions will be inserted here -->
                    </tbody>
                </table>
            </div>
        </main>
    </div>

    <script>
        const API_BASE = 'http://localhost:4000';
        let eventSource = null;

        async function handleConnectProvider() {
            console.log('Starting provider connection...');
            
            // Show overlay and disable button
            document.getElementById('authOverlay').classList.remove('hidden');
            document.getElementById('connectButton').disabled = true;
            
            try {
                const response = await fetch(`${API_BASE}/link-account`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ provider: 'Trellis Healthcare' })
                });
                
                const result = await response.json();
                
                if (result.status === 'success') {
                    // Hide overlay and show success
                    document.getElementById('authOverlay').classList.add('hidden');
                    document.getElementById('connectProviderCTA').classList.add('hidden');
                    document.getElementById('transactionSection').classList.remove('hidden');
                    document.getElementById('successMessage').classList.remove('hidden');
                    
                    // Add pending transaction
                    addTransaction({
                        id: 'TX-001',
                        provider: 'Downtown Dental Associates',
                        dateOfService: '2025-08-19',
                        patientResponsibility: 30.00,
                        currency: 'USD',
                        status: 'Pending',
                        source: 'Pending Verification'
                    });
                    
                    // Subscribe to real-time updates
                    subscribeToEvents();
                }
            } catch (error) {
                console.error('Connection failed:', error);
                document.getElementById('authOverlay').classList.add('hidden');
                document.getElementById('errorMessage').classList.remove('hidden');
                document.getElementById('connectButton').disabled = false;
            }
        }

        function addTransaction(transaction) {
            const tbody = document.getElementById('transactionTableBody');
            const row = document.createElement('tr');
            row.className = `status-${transaction.status.toLowerCase()}`;
            row.id = `transaction-${transaction.id}`;
            
            row.innerHTML = `
                <td>${transaction.provider}</td>
                <td>${transaction.dateOfService}</td>
                <td>$${transaction.patientResponsibility}</td>
                <td class="status-${transaction.status.toLowerCase()}">${transaction.status}</td>
                <td>${transaction.source}</td>
            `;
            
            tbody.appendChild(row);
        }

        function updateTransaction(transactionId, updates) {
            const row = document.getElementById(`transaction-${transactionId}`);
            if (row) {
                const cells = row.cells;
                if (updates.status) {
                    cells[3].textContent = updates.status;
                    cells[3].className = `status-${updates.status.toLowerCase()}`;
                }
                if (updates.source) {
                    cells[4].textContent = updates.source;
                }
                row.className = `status-${updates.status.toLowerCase()}`;
            }
        }

        function subscribeToEvents() {
            eventSource = new EventSource(`${API_BASE}/events`);
            
            eventSource.onmessage = function(event) {
                const data = JSON.parse(event.data);
                console.log('Received event:', data);
                
                if (data.type === 'transactionUpdated') {
                    updateTransaction(data.transaction.id, {
                        status: data.transaction.status,
                        source: data.transaction.source
                    });
                }
            };
            
            eventSource.onerror = function(error) {
                console.error('EventSource error:', error);
                eventSource.close();
            };
        }

        // Test the API connection on page load
        window.addEventListener('load', async () => {
            try {
                const response = await fetch(`${API_BASE}/health`);
                const health = await response.json();
                console.log('Backend health check:', health);
            } catch (error) {
                console.error('Backend not available:', error);
            }
        });
    </script>
</body>
</html>
